name: Release on Merge

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    # Skip if commit message contains [skip ci] or is from github-actions bot
    if: |
      !contains(github.event.head_commit.message, '[skip ci]') &&
      github.event.head_commit.author.email != '41898282+github-actions[bot]@users.noreply.github.com'
    
    permissions:
      contents: write
    
    outputs:
      version: ${{ steps.version.outputs.new_version }}
      tag: ${{ steps.version.outputs.tag }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Get current version
      id: current_version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "current_version=$VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $VERSION"
    
    - name: Calculate new version
      id: version
      run: |
        CURRENT_VERSION="${{ steps.current_version.outputs.current_version }}"
        
        # Determine version bump type
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          BUMP="${{ github.event.inputs.version_bump }}"
        else
          # Default to patch for automatic merges
          BUMP="patch"
        fi
        
        # Parse current version
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        
        # Increment based on bump type
        case $BUMP in
          major)
            major=$((major + 1))
            minor=0
            patch=0
            ;;
          minor)
            minor=$((minor + 1))
            patch=0
            ;;
          patch)
            patch=$((patch + 1))
            ;;
        esac
        
        NEW_VERSION="${major}.${minor}.${patch}"
        TAG="v${NEW_VERSION}"
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "New version: $NEW_VERSION (bump: $BUMP)"
    
    - name: Update package.json version
      run: |
        NEW_VERSION="${{ steps.version.outputs.new_version }}"
        node -e "const fs=require('fs'); const pkg=JSON.parse(fs.readFileSync('package.json')); pkg.version='$NEW_VERSION'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2)+'\n');"
        echo "âœ… Updated package.json to version $NEW_VERSION"
    
    - name: Update Android version
      run: |
        NEW_VERSION="${{ steps.version.outputs.new_version }}"
        
        # Calculate versionCode from version (e.g., 1.2.3 -> 10203)
        IFS='.' read -r major minor patch <<< "$NEW_VERSION"
        VERSION_CODE=$((major * 10000 + minor * 100 + patch))
        
        # Update build.gradle with more robust patterns
        sed -i "s/versionCode\s\+[0-9]\+/versionCode $VERSION_CODE/" android/app/build.gradle
        sed -i "s/versionName\s\+\"[^\"]*\"/versionName \"$NEW_VERSION\"/" android/app/build.gradle
        
        echo "âœ… Updated Android version to $NEW_VERSION (code: $VERSION_CODE)"
    
    - name: Commit version bump
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add package.json android/app/build.gradle
        git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }} [skip ci]"
        git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.new_version }}"
        git push origin main
        git push origin "${{ steps.version.outputs.tag }}"
    
    - name: Generate changelog
      id: changelog
      run: |
        # Get the previous tag before we create the new one
        PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
          # No previous tags, get all commits
          COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges HEAD~1)
        else
          # Get commits since previous tag
          COMMITS=$(git log ${PREV_TAG}..HEAD~1 --pretty=format:"- %s (%h)" --no-merges)
        fi
        
        # Handle empty changelog
        if [ -z "$COMMITS" ]; then
          COMMITS="- No changes recorded"
        fi
        
        # Save to environment variable for the release step
        {
          echo 'CHANGELOG<<EOF'
          echo "$COMMITS"
          echo 'EOF'
        } >> $GITHUB_ENV
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Release ${{ steps.version.outputs.new_version }}
        body: |
          ## EuAiTalk v${{ steps.version.outputs.new_version }}
          
          ### ðŸŽ‰ What's New
          
          ${{ env.CHANGELOG }}
          
          ### ðŸ“¦ Assets
          
          Backend and Android artifacts will be uploaded shortly by the build jobs.
          
          ### ðŸš€ Installation
          
          **Backend:**
          ```bash
          # Extract the tarball
          tar -xzf euaitalk-backend-${{ steps.version.outputs.new_version }}.tar.gz
          cd euaitalk-backend-${{ steps.version.outputs.new_version }}
          
          # Configure environment
          cp .env.example .env
          # Edit .env and add your API keys
          
          # Install and start
          npm install
          npm start
          ```
          
          **Android:**
          Download the APK below and install it on your Android device.
          
          > **Note**: The APK may be signed or unsigned depending on the repository configuration. Unsigned APKs require enabling "Install from unknown sources" on your device.
        draft: false
        prerelease: false

  build-backend:
    needs: create-release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.create-release.outputs.tag }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm install
    
    - name: Create backend package
      run: |
        mkdir -p release-backend
        cp -r server public package.json package-lock.json .env.example release-backend/
        cd release-backend
        tar -czf ../euaitalk-backend-${{ needs.create-release.outputs.version }}.tar.gz .
        cd ..
        echo "âœ… Created backend package"
    
    - name: Upload backend to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag }}
        files: |
          euaitalk-backend-${{ needs.create-release.outputs.version }}.tar.gz

  build-android:
    needs: create-release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.create-release.outputs.tag }}
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.2'
    
    - name: Setup Android keystore
      if: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      run: |
        echo "Setting up Android keystore for signing..."
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/release.keystore
        echo "âœ… Keystore file created"
    
    - name: Build release APK
      env:
        ANDROID_KEYSTORE_FILE: ${{ secrets.ANDROID_KEYSTORE_BASE64 && 'release.keystore' || '' }}
        ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      run: |
        cd android
        if [ -n "$ANDROID_KEYSTORE_FILE" ]; then
          echo "Building signed release APK..."
        else
          echo "Building unsigned release APK (no keystore configured)..."
        fi
        gradle assembleRelease --stacktrace
    
    - name: Rename APK
      run: |
        if [ -f android/app/build/outputs/apk/release/app-release.apk ]; then
          APK_FILE="android/app/build/outputs/apk/release/app-release.apk"
          APK_TYPE="signed"
        elif [ -f android/app/build/outputs/apk/release/app-release-unsigned.apk ]; then
          APK_FILE="android/app/build/outputs/apk/release/app-release-unsigned.apk"
          APK_TYPE="unsigned"
        else
          echo "Error: Release APK not found"
          ls -la android/app/build/outputs/apk/release/
          exit 1
        fi
        
        mv "$APK_FILE" "EuAiTalk-${{ needs.create-release.outputs.version }}.apk"
        echo "âœ… Renamed ${APK_TYPE} APK to EuAiTalk-${{ needs.create-release.outputs.version }}.apk"
    
    - name: Clean up keystore
      if: always()
      run: |
        if [ -f android/release.keystore ]; then
          rm -f android/release.keystore
          echo "âœ… Cleaned up keystore file"
        fi
    
    - name: Upload APK to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag }}
        files: |
          EuAiTalk-${{ needs.create-release.outputs.version }}.apk
